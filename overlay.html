<!DOCTYPE html>
<html>
<head>
    <title>Jailex Unified Overlay</title>
    <script src="https://cdn.jsdelivr.net/npm/tmi.js@1.8.5/dist/tmi.min.js"></script>
    <style>
        /* Transparent background for Lightstream */
        body { background: transparent; color: white; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; margin: 0; }
        
        /* Chat container - messages flow from bottom up */
        #chat { 
            display: flex; 
            flex-direction: column-reverse; 
            height: 100vh; 
            padding: 15px; 
            box-sizing: border-box;
        }
        
        /* The Message Box: Chicago Bears Navy and Orange */
        .msg { 
            background: rgba(11, 22, 42, 0.95); /* Deep Navy */
            border-left: 5px solid #C83803; /* Bears Orange */
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 8px; 
            animation: slideIn 0.3s ease-out;
            font-size: 1.2rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            word-wrap: break-word;
        }

        /* Platform Identifiers */
        .platform-tag { font-weight: bold; margin-right: 10px; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; vertical-align: middle; }
        .twitch-tag { background: #6441a5; color: white; } /* Purple */
        .kick-tag { background: #00E701; color: black; } /* Green */
        
        .user { font-weight: bold; color: #FFA500; margin-right: 5px; }
        .content { color: #FFFFFF; }

        @keyframes slideIn { from { transform: translateX(-30px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
    </style>
</head>
<body>
    <div id="chat"></div>

    <script>
        const params = new URLSearchParams(window.location.search);
        const twitchToken = params.get('token');
        const kickId = params.get('kick_id');
        const kickUser = params.get('kick_user') || 'justquitbro7';

        // --- TWITCH CONNECTION ---
        if (twitchToken) {
            const client = new tmi.Client({
                options: { debug: false },
                identity: { password: `oauth:${twitchToken}`, username: 'justquitbro7' },
                channels: ['justquitbro7']
            });
            client.connect().catch(console.error);
            client.on('message', (channel, tags, message, self) => {
                addMessage('twitch', tags['display-name'] || tags.username, message);
            });
        }

        // --- KICK CONNECTION (via Pusher WebSocket) ---
        if (kickId) {
            const ws = new WebSocket('wss://ws-us2.pusher.com/app/eb1d5f283081a78b932c?protocol=7&client=js&version=7.0.6&flash=false');
            ws.onopen = () => {
                ws.send(JSON.stringify({ 
                    event: "pusher:subscribe", 
                    data: { auth: "", channel: `chatrooms.${kickId}.v2` } 
                }));
            };
            ws.onmessage = (e) => {
                const data = JSON.parse(e.data);
                if (data.event === "App\\Events\\ChatMessageEvent") {
                    const msgData = JSON.parse(data.data);
                    addMessage('kick', msgData.sender.username, msgData.content);
                }
            };
            ws.onclose = () => console.log("Kick connection closed. Reconnecting...");
        }

        // --- DISPLAY LOGIC ---
        function addMessage(platform, user, msg) {
            const chat = document.getElementById('chat');
            const div = document.createElement('div');
            div.className = 'msg';
            
            const tagClass = platform === 'twitch' ? 'twitch-tag' : 'kick-tag';
            
            div.innerHTML = `
                <span class="platform-tag ${tagClass}">${platform}</span>
                <span class="user">${user}:</span>
                <span class="content">${msg}</span>
            `;

            chat.prepend(div);
            
            // Keep only the last 50 messages to prevent lag
            if (chat.childNodes.length > 50) {
                chat.removeChild(chat.lastChild);
            }
        }
    </script>
</body>
</html>
