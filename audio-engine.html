/* ====== JAILEX AUDIO ENGINE ====== */
window.queue = [];
window.isSpeaking = false;
window.audioEnabled = false;
window.voices = [];

// GLOBAL FRONT DOOR
window.addMessage = function(msg) {
    const log = document.getElementById("chatLog");
    if (log) {
        const div = document.createElement("div");
        div.className = "chat-line";
        const color = msg.platform === "kick" ? "#53fc18" : "#a970ff";
        div.innerHTML = `<span style="color:${color};font-weight:800">[${msg.platform.toUpperCase()}] ${msg.username}:</span> ${msg.message}`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }
    window.queue.push(msg);
    document.getElementById("queueLen").textContent = window.queue.length;
};

function initVoices() {
    window.voices = speechSynthesis.getVoices();
    const kSelect = document.getElementById("kickVoice");
    if (kSelect && window.voices.length > 0) {
        kSelect.innerHTML = "";
        window.voices.forEach(v => {
            let opt = document.createElement("option");
            opt.value = v.name; opt.textContent = v.name;
            kSelect.appendChild(opt);
        });
    } else { setTimeout(initVoices, 300); }
}
speechSynthesis.onvoiceschanged = initVoices; initVoices();

// MAIN TTS LOOP
setInterval(() => {
    if (!window.audioEnabled || window.isSpeaking || window.queue.length === 0) return;
    const next = window.queue.shift();
    document.getElementById("queueLen").textContent = window.queue.length;
    document.getElementById("speakingNow").textContent = next.username;
    
    window.isSpeaking = true;
    const readUser = document.getElementById("readUsername").checked;
    const text = readUser ? `${next.username} says ${next.message}` : next.message;
    
    const utter = new SpeechSynthesisUtterance(text);
    utter.volume = parseFloat(document.getElementById("volume").value);
    utter.voice = window.voices.find(v => v.name === document.getElementById("kickVoice").value);
    
    utter.onend = () => { 
        window.isSpeaking = false; 
        document.getElementById("speakingNow").textContent = "None"; 
    };
    
    speechSynthesis.speak(utter);
}, 250);
