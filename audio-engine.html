/* ====== JAILEX AUDIO ENGINE (GLOBAL HUB) ====== */

// 1. ENGINE STATE
window.ttsQueue = [];
window.isSpeaking = false;
window.audioEnabled = false;
window.browserVoices = [];

// 2. THE HANDSHAKE (Used by Kick and Twitch)
window.addMessage = function(msg) {
    // A. Update Chat HUD
    const log = document.getElementById("chatLog");
    if (log) {
        const div = document.createElement("div");
        div.className = "chat-line";
        const color = msg.platform === "kick" ? "#53fc18" : "#a970ff";
        div.innerHTML = `<span style="color:${color};font-weight:800">[${msg.platform.toUpperCase()}] ${msg.username}:</span> ${msg.message}`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    // B. Add to Speaking Queue
    window.ttsQueue.push(msg);
    const qLen = document.getElementById("queueLen");
    if (qLen) qLen.textContent = window.ttsQueue.length;
};

// 3. VOICE LOADING
function loadSystemVoices() {
    window.browserVoices = speechSynthesis.getVoices();
    const selector = document.getElementById("voiceSelect");
    if (selector && window.browserVoices.length > 0) {
        selector.innerHTML = "";
        window.browserVoices.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v.name;
            opt.textContent = `${v.name} (${v.lang})`;
            selector.appendChild(opt);
        });
    } else {
        setTimeout(loadSystemVoices, 300); // Retry until browser loads them
    }
}
speechSynthesis.onvoiceschanged = loadSystemVoices;
loadSystemVoices();

// 4. THE PLAYBACK LOOP (Checks every 150ms)
setInterval(() => {
    // Only speak if initialized, not already speaking, and queue isn't empty
    if (!window.audioEnabled || window.isSpeaking || window.ttsQueue.length === 0) return;

    const next = window.ttsQueue.shift();
    
    // Update UI Stats
    if (document.getElementById("queueLen")) document.getElementById("queueLen").textContent = window.ttsQueue.length;
    if (document.getElementById("speakingNow")) document.getElementById("speakingNow").textContent = next.username;

    window.isSpeaking = true;

    // Check if we should read username
    const readUserCheck = document.getElementById("readUsername");
    const textToSay = (readUserCheck && readUserCheck.checked) 
        ? `${next.username} says: ${next.message}` 
        : next.message;

    const utter = new SpeechSynthesisUtterance(textToSay);
    
    // Apply Volume
    const volInput = document.getElementById("volume");
    utter.volume = volInput ? parseFloat(volInput.value) : 1;

    // Apply Selected Voice
    const voiceChoice = document.getElementById("voiceSelect");
    if (voiceChoice) {
        const selectedVoice = window.browserVoices.find(v => v.name === voiceChoice.value);
        if (selectedVoice) utter.voice = selectedVoice;
    }

    // End Handler
    utter.onend = () => {
        window.isSpeaking = false;
        if (document.getElementById("speakingNow")) document.getElementById("speakingNow").textContent = "None";
    };

    utter.onerror = () => {
        window.isSpeaking = false;
        if (document.getElementById("speakingNow")) document.getElementById("speakingNow").textContent = "None";
    };

    speechSynthesis.speak(utter);
}, 150);
