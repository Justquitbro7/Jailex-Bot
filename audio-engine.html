/* ====== JAILEX AUDIO ENGINE (FULL FILE) ====== */

// 1. GLOBAL STATE
let queue = [];
let isSpeaking = false;
let audioEnabled = false;
let isMuted = false;
let isPlaying = true;
let voices = [];

// Settings managed by UI sliders in script.js
let ttsVolume = 1;
let ttsRate = 1;
let ttsPitch = 1;

// Engine choice: "browser" or "speechify"
let ttsEngine = "browser"; 
let speechifyApiKey = "";
let speechifyVoiceId = "";

/* ====== VOICE LOADER (BROWSER) ====== */
function initVoices() {
  voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    setTimeout(initVoices, 200);
    return;
  }
  
  const kSelect = document.getElementById("kickVoice");
  const tSelect = document.getElementById("timerVoice");

  if (kSelect && tSelect) {
    kSelect.innerHTML = "";
    tSelect.innerHTML = "";
    voices.forEach(v => {
      let opt = document.createElement("option");
      opt.value = v.name; 
      opt.textContent = v.name;
      kSelect.appendChild(opt.cloneNode(true));
      tSelect.appendChild(opt.cloneNode(true));
    });
  }
}

// Handle browser voice loading
if (speechSynthesis.onvoiceschanged !== undefined) {
  speechSynthesis.onvoiceschanged = initVoices;
}
initVoices();

/* ====== THE SPEAKING LOOP ====== */
setInterval(async () => {
  // Don't speak if audio isn't enabled, we're muted, paused, already speaking, or queue is empty
  if (!audioEnabled || !isPlaying || isMuted || isSpeaking || queue.length === 0) return;

  // Get the next message from the queue
  const next = queue.shift();
  
  // Update UI stats
  const qDisplay = document.getElementById("queueLen");
  const nowDisplay = document.getElementById("speakingNow");
  if (qDisplay) qDisplay.textContent = queue.length;
  if (nowDisplay) nowDisplay.textContent = next.username || "System";

  // Build the text based on the "Read Username" checkbox
  const readUserCheck = document.getElementById("readUsername");
  const textToSpeak = (readUserCheck && readUserCheck.checked) 
    ? `${next.username} says: ${next.message}` 
    : next.message;

  isSpeaking = true;

  // CHOICE: SPEECHIFY VS BROWSER
  if (ttsEngine === "speechify" && speechifyApiKey) {
    await speakWithSpeechify(textToSpeak);
  } else {
    // Standard Browser TTS
    const utter = new SpeechSynthesisUtterance(textToSpeak);
    utter.volume = ttsVolume;
    utter.rate = ttsRate;
    utter.pitch = ttsPitch;
    
    // Pick the voice assigned in the UI
    const vId = (next.platform === "kick") ? "kickVoice" : "timerVoice";
    const vElement = document.getElementById(vId);
    if (vElement) {
      utter.voice = voices.find(v => v.name === vElement.value);
    }

    utter.onend = () => {
      isSpeaking = false;
      if (nowDisplay) nowDisplay.textContent = "None";
    };

    utter.onerror = () => {
      isSpeaking = false;
      if (nowDisplay) nowDisplay.textContent = "None";
    };

    speechSynthesis.speak(utter);
  }
}, 250);

/* ====== SPEECHIFY API INTEGRATION ====== */
async function speakWithSpeechify(text) {
  if (!speechifyApiKey || !speechifyVoiceId) {
    isSpeaking = false;
    return;
  }

  try {
    const res = await fetch("https://api.sws.speechify.com/v1/audio/speech", {
      method: "POST",
      headers: {
        "Authorization": `Bearer ${speechifyApiKey}`,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        voice_id: speechifyVoiceId,
        text: text,
        audio_format: "mp3"
      })
    });

    if (!res.ok) throw new Error("Speechify API Failed");

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    const audio = document.getElementById("speechifyAudio");
    
    if (audio) {
      audio.src = url;
      audio.play();
      audio.onended = () => {
        isSpeaking = false;
        URL.revokeObjectURL(url);
        document.getElementById("speakingNow").textContent = "None";
      };
    }
  } catch (err) {
    console.error(err);
    isSpeaking = false;
  }
}

/* ====== GLOBAL ADD MESSAGE HELPER ====== */
// This is the function kick.js and twitch.js use to send data here
function addMessage(msg) {
  // Add to the visual chat log
  const log = document.getElementById("chatLog");
  if (log) {
    const div = document.createElement("div");
    div.className = "chat-line";
    const color = msg.platform === "kick" ? "#53fc18" : "#a970ff";
    div.innerHTML = `<span style="color:${color};font-weight:600">[${msg.platform.toUpperCase()}] ${msg.username}:</span> ${msg.message}`;
    log.appendChild(div);
    log.scrollTop = log.scrollHeight;
  }

  // Push to the TTS queue
  queue.push(msg);
  const qDisplay = document.getElementById("queueLen");
  if (qDisplay) qDisplay.textContent = queue.length;
}
