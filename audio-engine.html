/* ====== JAILEX AUDIO ENGINE (v1.3.0) ====== */

// 1. ENGINE STATE
window.queue = [];
window.isSpeaking = false; 
window.audioEnabled = false;
window.isPlaying = true;
window.voices = [];

// 2. THE HANDSHAKE (Global function that Quick Sync Engine calls)
window.addMessage = function(msg) {
    console.log("JAILEX: Audio Engine Received:", msg);

    // Update the Chat HUD Visuals
    const log = document.getElementById("chatLog");
    if (log) {
        const div = document.createElement("div");
        div.className = "chat-line";
        const color = msg.platform === "kick" ? "#53fc18" : "#a970ff";
        div.innerHTML = `<span style="color:${color};font-weight:800">[${msg.platform.toUpperCase()}] ${msg.username}:</span> ${msg.message}`;
        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }

    // Add to the Speaking Queue
    window.queue.push(msg);
    if (document.getElementById("queueLen")) {
        document.getElementById("queueLen").textContent = window.queue.length;
    }
};

// 3. THE PLAYBACK LOOP (Heartbeat: Checks every 100ms)
setInterval(() => {
    // Only speak if user has initialized engine, we aren't already speaking, and queue has items
    if (!window.audioEnabled || window.isSpeaking || window.queue.length === 0) {
        return;
    }

    const next = window.queue.shift();
    if (document.getElementById("queueLen")) document.getElementById("queueLen").textContent = window.queue.length;
    if (document.getElementById("speakingNow")) document.getElementById("speakingNow").textContent = next.username;

    window.isSpeaking = true;

    // Read Username logic
    const readUserCheck = document.getElementById("readUsername");
    const textToSay = (readUserCheck && readUserCheck.checked) 
        ? `${next.username} says: ${next.message}` 
        : next.message;

    const utter = new SpeechSynthesisUtterance(textToSay);
    
    // Set Volume
    const volInput = document.getElementById("volume");
    utter.volume = volInput ? parseFloat(volInput.value) : 1;
    
    // Set Voice
    const voiceSelect = document.getElementById("voiceSelect");
    if (voiceSelect && window.voices.length > 0) {
        const voiceMatch = window.voices.find(v => v.name === voiceSelect.value);
        if (voiceMatch) utter.voice = voiceMatch;
    }

    // Handlers
    utter.onend = () => {
        window.isSpeaking = false;
        document.getElementById("speakingNow").textContent = "None";
    };
    utter.onerror = () => {
        window.isSpeaking = false;
        document.getElementById("speakingNow").textContent = "None";
    };

    speechSynthesis.speak(utter);
}, 100);

// 4. VOICE LOADER
function initVoices() {
    window.voices = speechSynthesis.getVoices();
    const selector = document.getElementById("voiceSelect");
    if (selector && window.voices.length > 0) {
        selector.innerHTML = "";
        window.voices.forEach(v => {
            const opt = document.createElement("option");
            opt.value = v.name; opt.textContent = v.name;
            selector.appendChild(opt);
        });
    } else {
        setTimeout(initVoices, 300);
    }
}
speechSynthesis.onvoiceschanged = initVoices;
initVoices();
