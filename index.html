<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script>
        // EMERGENCY BRAKE: Run this before anything else loads
        const hash = window.location.hash;
        if (hash.includes('access_token=')) {
            const params = new URLSearchParams(hash.substring(1));
            const token = params.get('access_token');
            // Save it safely and WIPE the URL to kill the loop
            localStorage.setItem('jailex_twitch_token', token);
            window.history.replaceState({}, document.title, "/");
            console.log("Loop Killed. Token Saved.");
        }
    </script>
    <title>Jailex Bot Overlay</title>
    <style>
        body { background: rgba(0,0,0,0); color: white; font-family: sans-serif; padding: 20px; text-shadow: 2px 2px 4px #000; }
        #chat-container { display: flex; flex-direction: column; justify-content: flex-end; height: 80vh; max-width: 400px; }
        .message { background: rgba(0,0,0,0.7); margin-bottom: 8px; padding: 10px; border-radius: 8px; border-left: 5px solid #9146ff; }
        #login-btn { background: #9146ff; color: white; border: none; padding: 12px 20px; border-radius: 5px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>

    <button id="login-btn" onclick="loginWithTwitch()">Connect Jailex to Twitch</button>

    <div id="chat-container">
        <div class="message">System: Awaiting Twitch...</div>
    </div>

    <script src="twitch.js"></script>

    <script>
        function addMessage(user, text) {
            const container = document.getElementById('chat-container');
            const msgDiv = document.createElement('div');
            msgDiv.className = 'message';
            msgDiv.innerHTML = `<strong>${user}:</strong> ${text}`;
            container.appendChild(msgDiv);
        }

        // Check if we just saved a token from the Emergency Brake above
        const savedToken = localStorage.getItem('jailex_twitch_token');
        if (savedToken) {
            document.getElementById('login-btn').style.display = 'none';
            // Now we can safely use the token to get your ID in twitch.js
            if (window.fetchTwitchID) {
                fetchTwitchID(savedToken);
                localStorage.removeItem('jailex_twitch_token'); // Clean up
            }
        }
    </script>
</body>
</html>
