<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jailex Bot v5.1 - TTS Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: 'Inter', sans-serif; }
        .status-on { color: #22c55e; text-shadow: 0 0 10px rgba(34, 197, 94, 0.5); }
        .status-off { color: #ef4444; }
        .version-badge { background: #1e293b; padding: 2px 8px; border-radius: 4px; font-size: 10px; color: #94a3b8; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-2xl mx-auto bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
        <div class="flex justify-between items-center mb-4 border-b border-slate-700 pb-2">
            <h1 class="text-3xl font-bold text-blue-400">Jailex Bot Engine</h1>
            <span class="version-badge">v5.1</span>
        </div>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-slate-900 p-3 rounded-lg border border-slate-700">
                <p class="text-xs text-slate-400 uppercase tracking-wider">Kick Status</p>
                <p id="kick-status" class="font-bold status-off text-lg">Disconnected</p>
            </div>
            <div id="tts-indicator" class="bg-slate-900 p-3 rounded-lg border border-slate-700 transition-all duration-300">
                <p class="text-xs text-slate-400 uppercase tracking-wider">Audio Engine</p>
                <p id="engine-status" class="font-bold text-yellow-500 text-lg">Locked (Click Start)</p>
            </div>
        </div>

        <div class="space-y-4">
            <div class="bg-slate-900 p-4 rounded-lg">
                <label class="block text-sm font-medium text-slate-400 mb-2">TTS Volume (<span id="vol-val">100</span>%)</label>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
            </div>
            
            <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-4 px-4 rounded-lg shadow-lg transform active:scale-95 transition-all flex items-center justify-center gap-2">
                <span>âš¡</span> ACTIVATE & RESET ENGINE
            </button>
        </div>

        <div class="mt-6">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xs font-semibold text-slate-500 uppercase">Live Chat Feed</h2>
                <span id="queue-count" class="text-xs text-blue-400 font-mono">Queue: 0</span>
            </div>
            <div id="chat-log" class="bg-black p-4 h-56 overflow-y-auto rounded-lg text-sm font-mono border border-slate-700 space-y-1">
                <p class="text-slate-600 italic">Waiting for connection...</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const KICK_CHANNEL = "justquitbro7";
        const KICK_BOTS = ["botrix", "kickbot", "streamelements", "nightbot", "moobot"];
        
        // ENGINE STATE
        let queue = [];
        let isSpeaking = false;
        let processedIds = new Set();
        let volume = 1;
        let audioUnlocked = false;

        // UI ELEMENTS
        const kickStatusEl = document.getElementById('kick-status');
        const queueCountEl = document.getElementById('queue-count');
        const chatLogEl = document.getElementById('chat-log');
        const startBtn = document.getElementById('start-btn');
        const volSlider = document.getElementById('volume');
        const volVal = document.getElementById('vol-val');
        const engineStatus = document.getElementById('engine-status');

        // --- 1. THE TTS ENGINE ---
        function processQueue() {
            // Priority Check: Is browser speech working?
            if (isSpeaking || queue.length === 0 || !audioUnlocked) return;

            const next = queue.shift();
            isSpeaking = true;
            updateUI();

            const text = `${next.user} says ${next.msg}`;
            const utterance = new SpeechSynthesisUtterance(text);
            
            utterance.volume = volume;
            utterance.rate = 1; 

            utterance.onend = () => {
                isSpeaking = false;
                setTimeout(processQueue, 200); // Small gap between messages
            };

            utterance.onerror = (e) => {
                console.error("TTS Error:", e);
                isSpeaking = false;
                processQueue();
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- 2. THE KICK CONNECTION (PUSHER) ---
        async function connectKick() {
            try {
                const res = await fetch(`https://kick.com/api/v2/channels/${KICK_CHANNEL}`);
                const data = await res.json();
                const chatroomId = data.chatroom?.id;

                if (!chatroomId) throw new Error("ID Not Found");

                const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");

                ws.onopen = () => {
                    ws.send(JSON.stringify({
                        event: "pusher:subscribe",
                        data: { channel: `chatrooms.${chatroomId}.v2` }
                    }));
                };

                ws.onmessage = (e) => {
                    const raw = JSON.parse(e.data);
                    
                    if (raw.event === "pusher_internal:subscription_succeeded") {
                        kickStatusEl.innerText = "Connected";
                        kickStatusEl.className = "font-bold status-on text-lg";
                    }

                    if (raw.event === "App\\Events\\ChatMessageEvent") {
                        const chat = JSON.parse(raw.data);
                        const user = chat.sender?.username;
                        const msg = chat.content;
                        const id = chat.id;

                        if (KICK_BOTS.includes(user.toLowerCase()) || processedIds.has(id)) return;

                        processedIds.add(id);
                        addChatToLog(user, msg);
                        queue.push({ user, msg });
                        updateUI();
                    }
                };

                ws.onclose = () => {
                    kickStatusEl.innerText = "Reconnecting...";
                    setTimeout(connectKick, 5000);
                };

            } catch (err) {
                console.error("Kick Connect Fail:", err);
                setTimeout(connectKick, 10000);
            }
        }

        // --- 3. UTILITIES ---
        function updateUI() {
            queueCountEl.innerText = `Queue: ${queue.length}`;
        }

        function addChatToLog(user, msg) {
            const p = document.createElement('p');
            p.className = "border-l-2 border-blue-500 pl-2 bg-slate-900/50 py-1";
            p.innerHTML = `<span class="text-blue-400 font-bold">${user}:</span> <span class="text-slate-300">${msg}</span>`;
            chatLogEl.prepend(p);
            if (chatLogEl.children.length > 30) chatLogEl.lastChild.remove();
        }

        // --- 4. THE MAGIC FIX (USER INTERACTION) ---
        startBtn.addEventListener('click', () => {
            // This "unlocks" the speech engine for the browser session
            audioUnlocked = true;
            window.speechSynthesis.cancel(); 
            
            // Dummy speech to wake it up
            const wakeUp = new SpeechSynthesisUtterance("Engine activated");
            wakeUp.volume = 0; // Silent
            window.speechSynthesis.speak(wakeUp);

            engineStatus.innerText = "Active";
            engineStatus.className = "font-bold status-on text-lg";
            startBtn.classList.replace('bg-blue-600', 'bg-green-600');
            
            isSpeaking = false;
            console.log("TTS Audio Unlocked by User");
        });

        volSlider.addEventListener('input', (e) => {
            volume = e.target.value;
            volVal.innerText = Math.round(volume * 100);
        });

        // Run checking loop
        setInterval(processQueue, 100);
        connectKick();
    </script>
</body>
</html>
