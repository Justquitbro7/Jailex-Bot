<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jailexbot - Bears Ultimate HUD</title>
    <style>
        :root {
            --bears-navy: #0B162A;
            --bears-orange: #C83803;
            --bears-white: #FFFFFF;
            --kick-green: #53fc18;
            --twitch-purple: #6441a5;
        }

        body {
            background: linear-gradient(135deg, #050a14 0%, var(--bears-navy) 100%);
            color: #fff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        .hud-container {
            width: 100%;
            max-width: 1100px;
            background: rgba(11, 22, 42, 0.9);
            border: 2px solid var(--bears-orange);
            border-radius: 15px;
            box-shadow: 0 0 25px rgba(200, 56, 3, 0.5);
            padding: 25px;
        }

        h1 {
            color: var(--bears-orange);
            text-transform: uppercase;
            text-shadow: 0 0 10px var(--bears-orange);
            text-align: center;
            margin-top: 0;
            letter-spacing: 2px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .panel {
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            background: rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        h2 { font-size: 1.2em; margin-bottom: 15px; border-bottom: 1px solid var(--bears-orange); padding-bottom: 5px; }

        .status-bar { display: flex; gap: 10px; margin-bottom: 20px; justify-content: center; flex-wrap: wrap; }
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; display: flex; align-items: center; gap: 8px; background: #000; border: 1px solid #333; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #444; }
        .dot.active { background: var(--bears-orange); box-shadow: 0 0 8px var(--bears-orange); animation: pulse 2s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }

        input, select {
            width: 100%;
            background: #000;
            border: 1px solid var(--bears-orange);
            color: #fff;
            padding: 8px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .hint { font-size: 10px; color: #888; display: block; margin-top: -10px; margin-bottom: 10px; }

        button {
            background: transparent;
            color: var(--bears-orange);
            border: 2px solid var(--bears-orange);
            padding: 10px;
            cursor: pointer;
            font-weight: bold;
            text-transform: uppercase;
            border-radius: 5px;
            width: 100%;
            transition: 0.3s;
            margin-bottom: 10px;
        }

        button:hover { background: var(--bears-orange); color: white; }

        .unlock-btn { background: var(--bears-orange); color: white; margin-bottom: 20px; font-size: 1.1em; border-color: white; }
        .unlock-btn.active { background: white; color: var(--bears-navy); }

        .log-box {
            height: 250px;
            overflow-y: auto;
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            font-family: monospace;
            font-size: 13px;
            border-radius: 5px;
            margin-top: 10px;
            color: #0f0;
        }

        .log-entry { margin-bottom: 5px; padding: 4px; border-left: 3px solid #333; color: white; }
        .log-entry.twitch { border-color: var(--twitch-purple); }
        .log-entry.kick { border-color: var(--kick-green); }
        .log-entry.system { border-color: var(--bears-orange); color: var(--bears-orange); }
        .username { color: var(--bears-orange); font-weight: bold; }

        .dynamic-list { margin-top: 10px; max-height: 120px; overflow-y: auto; }
        .list-item { font-size: 12px; display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.05); padding: 5px; margin-bottom: 5px; border-radius: 4px; }
        .delete-btn { width: auto; padding: 2px 8px; border-color: #ff4444; color: #ff4444; font-size: 10px; margin: 0; }
    </style>
</head>
<body>

<div class="hud-container">
    <h1>üêª Jailex Ultimate HUD</h1>

    <div class="status-bar">
        <div class="badge"><div id="twitch-dot" class="dot"></div> Twitch: <span id="twitch-status">Offline</span></div>
        <div class="badge"><div id="kick-dot" class="dot"></div> Kick: <span id="kick-status">Offline</span></div>
        <div class="badge"><div id="tts-dot" class="dot"></div> TTS: <span id="tts-status">Locked</span></div>
    </div>

    <button id="unlock-btn" class="unlock-btn" onclick="unlockTTS()">üì¢ Enable Team Audio (TTS)</button>

    <div class="grid">
        <div class="left-col">
            <div class="panel">
                <h2>Twitch Config</h2>
                <label>Username</label>
                <input type="text" id="twitchUser" placeholder="justquitbro7">
                <label>OAuth Token</label>
                <span class="hint">From twitchapps.com/tmi</span>
                <input type="password" id="twitchOAuth" placeholder="Paste token here">
                <button id="connectTwitchBtn" onclick="connectTwitch()">Connect Twitch</button>
            </div>

            <div class="panel">
                <h2 style="color: var(--kick-green);">Kick Config</h2>
                <label>Chatroom ID</label>
                <input type="text" id="kickChatroomId" placeholder="e.g. 123456">
                <label>Bearer Token</label>
                <span class="hint">For sending bot responses</span>
                <input type="password" id="kickToken" placeholder="Bearer xxx">
                <button id="connectKickBtn" onclick="connectKick()" style="border-color:var(--kick-green); color:var(--kick-green);">Connect Kick</button>
            </div>

            <div class="panel">
                <h2>TTS Audio</h2>
                <label>Voice Selection</label>
                <select id="voice-select"></select>
                <div style="display:flex; gap:10px;">
                    <div style="flex:1;"><label>Rate</label><input type="range" id="rate" min="0.5" max="2" step="0.1" value="1"></div>
                    <div style="flex:1;"><label>Pitch</label><input type="range" id="pitch" min="0.5" max="2" step="0.1" value="1"></div>
                </div>
            </div>
        </div>

        <div class="right-col">
            <div class="panel">
                <h2>Automations</h2>
                <label>Keyword Trigger</label>
                <input type="text" id="kwTrigger" placeholder="!discord">
                <input type="text" id="kwResponse" placeholder="Join here: discord.gg/...">
                <button onclick="addKeyword()">Save Keyword</button>
                <div id="keywordList" class="dynamic-list"></div>
            </div>

            <div class="panel">
                <h2>Timed Messages</h2>
                <input type="number" id="timerMinutes" placeholder="Minutes (e.g. 10)">
                <input type="text" id="timerMessage" placeholder="Check out my Kick/Twitch!">
                <button onclick="addTimer()">Start Timer</button>
                <div id="timerList" class="dynamic-list"></div>
            </div>
            
            <div class="log-box" id="sysLog">
                > SYSTEM INITIALIZED. WAITING FOR CONNECTIONS...
            </div>
        </div>
    </div>
</div>

<script>
    const KNOWN_BOTS = ['nightbot', 'streamelements', 'moobot', 'fossabot', 'wizebot', 'streamlabs', 'botrix', 'kickbot'];
    let twitchWs, kickWs, ttsUnlocked = false, isSpeaking = false, ttsQueue = [];
    let keywords = {}, activeTimers = [], timerIntervals = [];
    let isTwitchConnected = false, isKickConnected = false;

    window.onload = () => {
        const toSave = ['twitchUser', 'twitchOAuth', 'kickChatroomId', 'kickToken'];
        toSave.forEach(id => {
            if(localStorage.getItem(id)) document.getElementById(id).value = localStorage.getItem(id);
            document.getElementById(id).addEventListener('input', (e) => localStorage.setItem(id, e.target.value));
        });

        if(localStorage.getItem('jailexKeywords')) {
            keywords = JSON.parse(localStorage.getItem('jailexKeywords'));
            updateKeywordList();
        }
        
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
    };

    /* --- TTS ENGINE --- */
    function loadVoices() {
        const voices = speechSynthesis.getVoices();
        const select = document.getElementById('voice-select');
        select.innerHTML = voices.map(v => `<option value="${v.name}">${v.name} (${v.lang})</option>`).join('');
    }

    function unlockTTS() {
        ttsUnlocked = true;
        speechSynthesis.cancel();
        const s = new SpeechSynthesisUtterance("Audio active");
        speechSynthesis.speak(s);
        document.getElementById('unlock-btn').innerText = "üêª Audio Ready";
        document.getElementById('unlock-btn').classList.add('active');
        document.getElementById('tts-dot').classList.add('active');
        document.getElementById('tts-status').innerText = "Active";
    }

    function speak(text) {
        if (!ttsUnlocked) return;
        ttsQueue.push(text);
        processQueue();
    }

    function processQueue() {
        if (isSpeaking || ttsQueue.length === 0) return;
        isSpeaking = true;
        const msg = new SpeechSynthesisUtterance(ttsQueue.shift());
        const voices = speechSynthesis.getVoices();
        msg.voice = voices.find(v => v.name === document.getElementById('voice-select').value);
        msg.rate = document.getElementById('rate').value;
        msg.pitch = document.getElementById('pitch').value;
        msg.onend = () => { isSpeaking = false; processQueue(); };
        speechSynthesis.speak(msg);
    }

    /* --- LOGGING --- */
    function logMsg(platform, user, msg) {
        const log = document.getElementById('sysLog');
        const entry = document.createElement('div');
        entry.className = `log-entry ${platform}`;
        entry.innerHTML = `> [${platform.toUpperCase()}] <span class="username">${user}</span>: ${msg}`;
        log.prepend(entry);
        if(log.children.length > 50) log.lastChild.remove();
    }

    /* --- TWITCH CONNECTION (FIXED) --- */
    function connectTwitch() {
        const user = document.getElementById('twitchUser').value.toLowerCase().trim();
        let rawToken = document.getElementById('twitchOAuth').value.trim();
        
        // Scrubbing logic from the working version
        let cleanToken = rawToken.replace(/^0auth:/i, '').replace(/^oauth:/i, '').trim();
        if (cleanToken === '') {
            logMsg('system', 'TWITCH', "Error: Token is blank.");
            return;
        }

        const oauth = 'oauth:' + cleanToken;
        logMsg('system', 'TWITCH', "Connecting...");

        twitchWs = new WebSocket('wss://irc-ws.chat.twitch.tv:443');

        twitchWs.onopen = () => {
            twitchWs.send(`PASS ${oauth}`);
            twitchWs.send(`NICK ${user}`);
            twitchWs.send(`JOIN #${user}`);
        };

        twitchWs.onmessage = (e) => {
            const msg = e.data;
            if(msg.includes('PING :tmi.twitch.tv')) twitchWs.send('PONG :tmi.twitch.tv');

            if(msg.includes('366 ' + user)) {
                isTwitchConnected = true;
                document.getElementById('twitch-dot').classList.add('active');
                document.getElementById('twitch-status').innerText = "Connected";
                document.getElementById('connectTwitchBtn').innerText = "Twitch Linked";
                logMsg('system', 'TWITCH', `Success! Joined #${user}`);
            }

            if (msg.includes('NOTICE')) {
                let noticeMsg = msg.split(':')[2] || "Login Failed";
                logMsg('system', 'TWITCH REJECTED', noticeMsg.trim());
                twitchWs.close();
            }

            if(msg.includes('PRIVMSG')) {
                const parts = msg.split('!');
                const username = parts[0].substring(1);
                const chatText = msg.split('PRIVMSG')[1].split(':')[1].trim();
                
                if(!KNOWN_BOTS.includes(username.toLowerCase())) {
                    logMsg('twitch', username, chatText);
                    speak(`${username} says ${chatText}`);
                    handleAutomations('twitch', chatText);
                }
            }
        };

        twitchWs.onclose = () => {
            isTwitchConnected = false;
            document.getElementById('twitch-dot').classList.remove('active');
            document.getElementById('twitch-status').innerText = "Offline";
            document.getElementById('connectTwitchBtn').innerText = "Connect Twitch";
        };
    }

    /* --- KICK CONNECTION --- */
    function connectKick() {
        const roomId = document.getElementById('kickChatroomId').value.trim();
        if(!roomId) { logMsg('system', 'KICK', 'Error: Room ID required.'); return; }
        
        logMsg('system', 'KICK', 'Connecting...');
        kickWs = new WebSocket('wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=7.6.0');
        
        kickWs.onopen = () => {
            kickWs.send(JSON.stringify({ event: "pusher:subscribe", data: { channel: `chatrooms.${roomId}.v2` } }));
        };

        kickWs.onmessage = (e) => {
            const data = JSON.parse(e.data);
            if(data.event === "pusher:connection_established") {
                isKickConnected = true;
                document.getElementById('kick-dot').classList.add('active');
                document.getElementById('kick-status').innerText = "Connected";
                logMsg('system', 'KICK', 'Success! Connected.');
            }
            if(data.event === "App\\Events\\ChatMessageEvent") {
                const msgData = JSON.parse(data.data);
                const user = msgData.sender.username;
                const message = msgData.content;

                if(!KNOWN_BOTS.includes(user.toLowerCase())) {
                    logMsg('kick', user, message);
                    speak(`${user} says ${message}`);
                    handleAutomations('kick', message);
                }
            }
        };
    }

    /* --- AUTOMATIONS --- */
    function handleAutomations(platform, msg) {
        const text = msg.toLowerCase();
        for (let kw in keywords) {
            if(text.includes(kw)) {
                if(platform === 'twitch') sendTwitch(keywords[kw]);
                if(platform === 'kick') sendKick(keywords[kw]);
            }
        }
    }

    function sendTwitch(txt) {
        if(isTwitchConnected) {
            const channel = document.getElementById('twitchUser').value.toLowerCase();
            twitchWs.send(`PRIVMSG #${channel} :${txt}`);
            logMsg('system', 'TWITCH BOT', `Sent: ${txt}`);
        }
    }

    async function sendKick(txt) {
        const token = document.getElementById('kickToken').value;
        const roomId = document.getElementById('kickChatroomId').value;
        if(!token) return;
        try {
            await fetch('/api/kick', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chatroomId: roomId, token: token, message: txt })
            });
            logMsg('system', 'KICK BOT', `Sent: ${txt}`);
        } catch(e) { console.error("Kick post failed"); }
    }

    function addKeyword() {
        const k = document.getElementById('kwTrigger').value.toLowerCase().trim();
        const r = document.getElementById('kwResponse').value.trim();
        if(k && r) {
            keywords[k] = r;
            localStorage.setItem('jailexKeywords', JSON.stringify(keywords));
            updateKeywordList();
            document.getElementById('kwTrigger').value = '';
            document.getElementById('kwResponse').value = '';
        }
    }

    function updateKeywordList() {
        const list = document.getElementById('keywordList');
        list.innerHTML = Object.entries(keywords).map(([k,v]) => `
            <div class="list-item"><span><b>${k}</b>: ${v}</span><button class="delete-btn" onclick="removeKW('${k}')">X</button></div>
        `).join('');
    }

    function removeKW(k) { delete keywords[k]; localStorage.setItem('jailexKeywords', JSON.stringify(keywords)); updateKeywordList(); }

    function addTimer() {
        const mins = document.getElementById('timerMinutes').value;
        const msg = document.getElementById('timerMessage').value;
        if(mins > 0 && msg) {
            const id = setInterval(() => { sendTwitch(msg); sendKick(msg); }, mins * 60000);
            activeTimers.push({ mins, msg, id });
            updateTimerList();
            document.getElementById('timerMinutes').value = '';
            document.getElementById('timerMessage').value = '';
        }
    }

    function updateTimerList() {
        document.getElementById('timerList').innerHTML = activeTimers.map((t, i) => `
            <div class="list-item"><span>Every ${t.mins}m: ${t.msg}</span></div>
        `).join('');
    }
</script>
</body>
</html>
