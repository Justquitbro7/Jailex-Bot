<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jailex Bot - TTS Engine</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background-color: #0f172a; color: white; font-family: sans-serif; }
        .status-on { color: #22c55e; }
        .status-off { color: #ef4444; }
    </style>
</head>
<body class="p-6">

    <div class="max-w-2xl mx-auto bg-slate-800 p-6 rounded-xl shadow-2xl border border-slate-700">
        <h1 class="text-3xl font-bold mb-4 border-b border-slate-700 pb-2 text-blue-400">Jailex Bot Engine</h1>
        
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-slate-900 p-3 rounded-lg">
                <p class="text-sm text-slate-400">Kick Status</p>
                <p id="kick-status" class="font-bold status-off">Disconnected</p>
            </div>
            <div class="bg-slate-900 p-3 rounded-lg">
                <p class="text-sm text-slate-400">TTS Queue</p>
                <p id="queue-count" class="font-bold text-blue-400">0 Messages</p>
            </div>
        </div>

        <div class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-slate-400">TTS Volume</label>
                <input type="range" id="volume" min="0" max="1" step="0.1" value="1" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
            </div>
            <button id="start-btn" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 px-4 rounded-lg transition">
                Start / Reset TTS Engine
            </button>
            <p class="text-xs text-center text-slate-500 italic">Click "Start" if audio stops playing</p>
        </div>

        <div class="mt-6">
            <h2 class="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2">Recent Chat</h2>
            <div id="chat-log" class="bg-black p-4 h-48 overflow-y-auto rounded-lg text-sm font-mono border border-slate-700">
                <p class="text-slate-500 text-center mt-16">Waiting for messages...</p>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURATION
        const KICK_CHANNEL = "justquitbro7";
        const KICK_BOTS = ["botrix", "kickbot", "streamelements", "nightbot", "moobot"];

        // STATE
        let queue = [];
        let isSpeaking = false;
        let processedIds = new Set();
        let volume = 1;

        // ELEMENTS
        const kickStatusEl = document.getElementById('kick-status');
        const queueCountEl = document.getElementById('queue-count');
        const chatLogEl = document.getElementById('chat-log');
        const startBtn = document.getElementById('start-btn');
        const volSlider = document.getElementById('volume');

        // HELPER: Log to UI
        function logChat(user, msg) {
            const p = document.createElement('p');
            p.innerHTML = `<span class="text-green-400">[Kick]</span> <span class="text-blue-300">${user}:</span> ${msg}`;
            chatLogEl.prepend(p);
            if (chatLogEl.children.length > 20) chatLogEl.lastChild.remove();
        }

        // --- TTS ENGINE LOGIC ---
        function processQueue() {
            if (isSpeaking || queue.length === 0) return;

            isSpeaking = true;
            const nextMessage = queue.shift();
            queueCountEl.innerText = `${queue.length} Messages`;

            const textToSpeak = `${nextMessage.username} says: ${nextMessage.message}`;
            const utterance = new SpeechSynthesisUtterance(textToSpeak);
            
            utterance.volume = volume;
            utterance.onend = () => { isSpeaking = false; };
            utterance.onerror = () => { isSpeaking = false; };

            window.speechSynthesis.speak(utterance);
        }

        // Start checking the queue every 100ms
        setInterval(processQueue, 100);

        // --- KICK CONNECTION (BLUEPRINT LOGIC) ---
        async function connectKick() {
            try {
                // Step 1: Get chatroom ID
                const response = await fetch(`https://kick.com/api/v2/channels/${KICK_CHANNEL}`);
                const channelData = await response.json();
                const chatroomId = channelData.chatroom?.id;

                if (!chatroomId) throw new Error("No Chatroom ID");

                // Step 2: Connect to Pusher
                const ws = new WebSocket("wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false");

                ws.onopen = () => {
                    console.log("Connected to Kick Pusher");
                    ws.send(JSON.stringify({
                        event: "pusher:subscribe",
                        data: { channel: `chatrooms.${chatroomId}.v2` }
                    }));
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    
                    if (data.event === "pusher_internal:subscription_succeeded") {
                        kickStatusEl.innerText = "Connected";
                        kickStatusEl.className = "font-bold status-on";
                    }

                    if (data.event === "App\\Events\\ChatMessageEvent") {
                        const messageData = JSON.parse(data.data);
                        const user = messageData.sender?.username || "Unknown";
                        const msg = messageData.content || "";
                        const mId = messageData.id;

                        // Filter Bots & Duplicates
                        if (KICK_BOTS.includes(user.toLowerCase()) || processedIds.has(mId)) return;

                        processedIds.add(mId);
                        logChat(user, msg);
                        
                        // Add to Queue
                        queue.push({ username: user, message: msg });
                        queueCountEl.innerText = `${queue.length} Messages`;
                    }
                };

                ws.onclose = () => {
                    kickStatusEl.innerText = "Disconnected (Retrying...)";
                    kickStatusEl.className = "font-bold status-off";
                    setTimeout(connectKick, 5000);
                };

            } catch (err) {
                console.error("Kick Error:", err);
                setTimeout(connectKick, 10000);
            }
        }

        // Initialization
        startBtn.addEventListener('click', () => {
            window.speechSynthesis.cancel(); // Clear any "stuck" speech
            isSpeaking = false;
            alert("TTS Engine Reset & Activated");
        });

        volSlider.addEventListener('input', (e) => {
            volume = e.target.value;
        });

        // Run Connection
        connectKick();
    </script>
</body>
</html>
