<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Jailex HUD</title>

<style>
  body {
    margin: 0;
    padding: 0;
    background: radial-gradient(circle at center, #02030a 0%, #000000 80%);
    color: #f5f5f5;
    font-family: system-ui, sans-serif;
    overflow: hidden;
  }

  .app-container {
    display: flex;
    height: 100vh;
  }

  .sidebar {
    width: 220px;
    background: rgba(5,5,15,0.95);
    border-right: 1px solid rgba(255,255,255,0.15);
    box-shadow: 0 0 20px rgba(0,0,0,0.8);
    display: flex;
    flex-direction: column;
    padding: 16px 10px;
  }

  .sidebar-title {
    font-weight: 700;
    font-size: 18px;
    margin-bottom: 4px;
  }

  .sidebar-sub {
    font-size: 12px;
    opacity: 0.7;
    margin-bottom: 16px;
  }

  .tab-button {
    width: 100%;
    text-align: left;
    padding: 10px 12px;
    margin-bottom: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.15);
    background: rgba(10,10,20,0.9);
    color: #f5f5f5;
    cursor: pointer;
    font-weight: 600;
    font-size: 14px;
    box-shadow:
      0 0 10px rgba(255,122,24,0.25),
      inset 0 0 4px rgba(0,200,255,0.2);
    transition: 0.2s ease;
  }

  .tab-button:hover {
    box-shadow:
      0 0 16px rgba(255,122,24,0.6),
      inset 0 0 8px rgba(0,200,255,0.5);
    transform: translateY(-1px);
  }

  .tab-button.active {
    background: linear-gradient(135deg, rgba(255,122,24,0.9), rgba(0,200,255,0.7));
    box-shadow:
      0 0 20px rgba(255,122,24,0.9),
      0 0 14px rgba(0,200,255,0.8);
    border-color: rgba(255,255,255,0.6);
  }

  .version-tag {
    margin-top: auto;
    font-size: 12px;
    opacity: 0.7;
    text-align: center;
  }

  .main {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px 40px 20px;
  }

  .panel {
    backdrop-filter: blur(14px);
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 12px;
    padding: 16px;
    margin: 10px auto 20px auto;
    width: 100%;
    max-width: 900px;
    box-shadow:
      0 0 20px rgba(255,122,24,0.4),
      0 0 10px rgba(0,200,255,0.3);
    transition: 0.3s ease;
  }

  .panel:hover {
    box-shadow:
      0 0 30px rgba(255,122,24,0.6),
      0 0 20px rgba(0,200,255,0.5);
  }

  .panel h2 {
    margin-top: 0;
    padding-bottom: 6px;
    border-bottom: 2px solid rgba(255,122,24,0.6);
    text-shadow: 0 0 8px #ff7a18;
  }

  button {
    padding: 10px 16px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.2);
    background: rgba(10,10,20,0.8);
    color: #fff;
    cursor: pointer;
    font-weight: 600;
    margin-right: 8px;
    margin-top: 6px;
    transition: 0.25s ease;
    box-shadow:
      0 0 10px rgba(255,122,24,0.4),
      inset 0 0 6px rgba(0,200,255,0.3);
  }

  button:hover {
    box-shadow:
      0 0 18px rgba(255,122,24,0.8),
      inset 0 0 10px rgba(0,200,255,0.6);
    transform: translateY(-2px);
  }

  input[type=range] {
    width: 100%;
    margin-top: 6px;
    accent-color: #ff7a18;
  }

  input[type=text],
  input[type=number],
  input[type=password],
  select {
    width: 100%;
    padding: 6px 8px;
    margin-top: 6px;
    border-radius: 6px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(5,5,10,0.9);
    color: #f5f5f5;
    box-sizing: border-box;
  }

  #chatLog {
    max-height: 300px;
    overflow-y: auto;
    padding-right: 10px;
  }

  .chat-line {
    margin-bottom: 6px;
    font-size: 14px;
    animation: holoSlide 0.35s ease;
  }

  @keyframes holoSlide {
    0% { opacity: 0; transform: translateX(-12px); }
    60% { opacity: 0.6; }
    100% { opacity: 1; transform: translateX(0); }
  }

  .timer-item {
    margin-bottom: 10px;
    padding: 8px;
    border-radius: 8px;
    border: 1px solid rgba(255,255,255,0.25);
    background: rgba(5,5,10,0.8);
    font-size: 13px;
  }

  .timer-meta {
    opacity: 0.8;
    font-size: 12px;
  }

  .tab-panel {
    display: none;
  }

  .tab-panel.active {
    display: block;
  }

  .status-pill {
    display: inline-block;
    padding: 2px 8px;
    border-radius: 999px;
    font-size: 11px;
    margin-left: 6px;
  }

  .status-on {
    background: rgba(83,252,24,0.15);
    color: #53fc18;
    border: 1px solid rgba(83,252,24,0.6);
  }

  .status-off {
    background: rgba(255,122,24,0.15);
    color: #ff7a18;
    border: 1px solid rgba(255,122,24,0.6);
  }

  .hint {
    font-size: 11px;
    opacity: 0.75;
    margin-top: 4px;
  }
</style>
</head>
<body>

<div class="app-container">
  <div class="sidebar">
    <div class="sidebar-title">Jailex HUD</div>
    <div class="sidebar-sub">Control Deck</div>

    <button class="tab-button active" data-target="tab-playback">Playback</button>
    <button class="tab-button" data-target="tab-voices">Voices</button>
    <button class="tab-button" data-target="tab-chat">Chat</button>
    <button class="tab-button" data-target="tab-timers">Timers</button>
    <button class="tab-button" data-target="tab-connections">Connections</button>

    <div class="version-tag">
      Version 1.2.0 (Speechify + Voice Dropdown)
    </div>
  </div>

  <div class="main">
    <div id="tab-playback" class="tab-panel active">
      <div class="panel">
        <h2>Playback Control</h2>
        <button id="enableAudioBtn">Enable Audio</button>
        <button id="playPauseBtn">Pause</button>
        <button id="muteBtn">Mute</button>
        <button id="testTtsBtn">TEST TTS</button>
        <button id="testTimerBtn">TEST TIMER</button>

        <div style="margin-top:12px">
          <label>
            <input type="checkbox" id="readUsername" checked />
            Read username before message
          </label>
        </div>

        <p style="opacity:0.8;font-size:14px;margin-top:10px">
          Queue: <span id="queueLen">0</span>
          &nbsp;|&nbsp;
          Speaking: <span id="speakingNow">None</span>
        </p>
      </div>
    </div>

    <div id="tab-voices" class="tab-panel">
      <div class="panel">
        <h2>Voice Settings</h2>

        <label>TTS Engine</label>
        <select id="ttsEngineSelect">
          <option value="browser">Browser TTS</option>
          <option value="speechify">Speechify External TTS</option>
        </select>
        <div class="hint">
          Browser TTS = system voices. Speechify = external API (Snoop, etc., if your plan supports it).
        </div>

        <div id="browserTtsSettings" style="margin-top:14px;">
          <label>Kick Voice (Browser)</label>
          <select id="kickVoice"></select>

          <label style="margin-top:10px;display:block">Timer Voice (Browser)</label>
          <select id="timerVoice"></select>

          <label style="margin-top:10px;display:block">Volume</label>
          <input type="range" id="volume" min="0" max="1" step="0.01" value="1">

          <label style="margin-top:10px;display:block">Rate</label>
          <input type="range" id="rate" min="0.5" max="2" step="0.01" value="1">

          <label style="margin-top:10px;display:block">Pitch</label>
          <input type="range" id="pitch" min="0.5" max="2" step="0.01" value="1">
        </div>

        <div id="speechifySettings" style="margin-top:18px; display:none;">
          <h3 style="margin:0 0 8px 0;">Speechify Settings</h3>

          <label>Speechify API Key</label>
          <input type="password" id="speechifyApiKeyInput" placeholder="Paste your Speechify API key">

          <label style="margin-top:10px;">Speechify Voice ID</label>
          <input type="text" id="speechifyVoiceIdInput" placeholder="Will update when you pick from dropdown">

          <div class="hint">
            You must have a Speechify account and a valid voice_id. This app will call their API directly.
          </div>

          <button id="speechifyLoadVoicesBtn" style="margin-top:10px;">Load Speechify Voices</button>
          <select id="speechifyVoiceDropdown" style="margin-top:10px; width:100%;"></select>

          <button id="speechifyTestBtn" style="margin-top:10px;">Test Speechify Voice</button>
          <p id="speechifyStatus" style="font-size:12px; margin-top:6px; opacity:0.8;"></p>
        </div>
      </div>
    </div>

    <div id="tab-chat" class="tab-panel">
      <div class="panel">
        <h2>Chat Feed</h2>
        <div id="chatLog"></div>
      </div>
    </div>

    <div id="tab-timers" class="tab-panel">
      <div class="panel">
        <h2>Timers (up to 15)</h2>

        <div>
          <label>Timer Message</label>
          <input type="text" id="timerMessageInput" placeholder="What should this timer say?">

          <label style="margin-top:10px;display:block">Interval Preset</label>
          <select id="timerPresetSelect">
            <option value="30">30 seconds</option>
            <option value="60">1 minute</option>
            <option value="120">2 minutes</option>
            <option value="300">5 minutes</option>
            <option value="600">10 minutes</option>
            <option value="900">15 minutes</option>
            <option value="custom">Custom (seconds)</option>
          </select>

          <div id="customIntervalWrapper" style="display:none; margin-top:8px;">
            <label>Custom Interval (seconds)</label>
            <input type="number" id="customIntervalInput" min="1" value="60">
          </div>

          <button id="addTimerBtn" style="margin-top:10px;">Add Timer</button>
          <p id="timerError" style="color:#ff7a18; font-size:12px; margin-top:6px;"></p>
        </div>

        <div style="margin-top:16px;">
          <h3 style="margin:0 0 8px 0; font-size:16px;">Active Timers</h3>
          <div id="timersList"></div>
        </div>
      </div>
    </div>

    <div id="tab-connections" class="tab-panel">
      <div class="panel">
        <h2>Connections</h2>

        <h3 style="margin-top:0;">Kick</h3>
        <label>Kick Username</label>
        <input type="text" id="kickUsernameInput" readonly>

        <div style="margin-top:8px;">
          <label>
            <input type="checkbox" id="kickEnableCheckbox" checked disabled />
            Enable Kick
          </label>
          <span id="kickStatusPill" class="status-pill status-on">Connected (Auto)</span>
        </div>

        <hr style="margin:16px 0; border-color:rgba(255,255,255,0.2);">

        <h3>Twitch</h3>
        <label>Twitch Status</label>
        <input type="text" id="twitchUsernameInput" readonly>

        <label style="margin-top:8px;">Twitch OAuth Token (Hidden for security)</label>
        <input type="password" id="twitchTokenInput" readonly>

        <div style="margin-top:8px;">
          <label>
            <input type="checkbox" id="twitchEnableCheckbox" checked disabled />
            Enable Twitch
          </label>
          <span id="twitchStatusPill" class="status-pill status-off">Checking...</span>
        </div>

        <p style="margin-top:12px; font-size:12px; opacity:0.8; color: #ff7a18;" id="authWarning">
          </p>
      </div>
    </div>
  </div>
</div>

<audio id="speechifyAudio"></audio>

<script>
/* ====== AUTO-LOAD SAVED CREDENTIALS ====== */
const savedKickID = localStorage.getItem('jx_kick_id');
const savedKickUser = localStorage.getItem('jx_kick_user');
const savedTwitchToken = localStorage.getItem('jx_twitch_token');

// Redirect protection: if they don't have a Kick ID, send them back to setup
if (!savedKickID) {
    alert("Missing Kick configuration! Redirecting to setup...");
    window.location.href = "/setup.html";
}

/* ====== CONFIG / STATE ====== */
let queue = [];
let isPlaying = true;
let isMuted = false;
let isSpeaking = false;
let audioEnabled = false;

let voices = [];
let kickVoiceName = "";
let timerVoiceName = "";
let volume = 1;
let rate = 1;
let pitch = 1;

let timers = []; 

let ttsEngine = "browser";
let speechifyApiKey = "";
let speechifyVoiceId = "";

/* ====== ELEMENTS ====== */
const queueLen = document.getElementById("queueLen");
const speakingNow = document.getElementById("speakingNow");
const chatLog = document.getElementById("chatLog");

const enableAudioBtn = document.getElementById("enableAudioBtn");
const playPauseBtn = document.getElementById("playPauseBtn");
const muteBtn = document.getElementById("muteBtn");
const testTtsBtn = document.getElementById("testTtsBtn");
const testTimerBtn = document.getElementById("testTimerBtn");
const readUsernameBox = document.getElementById("readUsername");

const kickVoiceSelect = document.getElementById("kickVoice");
const timerVoiceSelect = document.getElementById("timerVoice");
const volumeSlider = document.getElementById("volume");
const rateSlider = document.getElementById("rate");
const pitchSlider = document.getElementById("pitch");

const ttsEngineSelect = document.getElementById("ttsEngineSelect");
const browserTtsSettings = document.getElementById("browserTtsSettings");
const speechifySettings = document.getElementById("speechifySettings");
const speechifyApiKeyInput = document.getElementById("speechifyApiKeyInput");
const speechifyVoiceIdInput = document.getElementById("speechifyVoiceIdInput");
const speechifyLoadVoicesBtn = document.getElementById("speechifyLoadVoicesBtn");
const speechifyVoiceDropdown = document.getElementById("speechifyVoiceDropdown");
const speechifyTestBtn = document.getElementById("speechifyTestBtn");
const speechifyStatus = document.getElementById("speechifyStatus");
const speechifyAudio = document.getElementById("speechifyAudio");

const timerMessageInput = document.getElementById("timerMessageInput");
const timerPresetSelect = document.getElementById("timerPresetSelect");
const customIntervalWrapper = document.getElementById("customIntervalWrapper");
const customIntervalInput = document.getElementById("customIntervalInput");
const addTimerBtn = document.getElementById("addTimerBtn");
const timersList = document.getElementById("timersList");
const timerError = document.getElementById("timerError");

// Connection UI Elements
const kickUsernameInput = document.getElementById("kickUsernameInput");
const kickStatusPill = document.getElementById("kickStatusPill");
const twitchUsernameInput = document.getElementById("twitchUsernameInput");
const twitchEnableCheckbox = document.getElementById("twitchEnableCheckbox");
const twitchStatusPill = document.getElementById("twitchStatusPill");
const twitchTokenInput = document.getElementById("twitchTokenInput");
const authWarning = document.getElementById("authWarning");

/* ====== INITIALIZE CONNECTIONS UI ====== */
// Fill Kick fields
kickUsernameInput.value = savedKickUser || "Unknown User";

// Fill Twitch fields
if (savedTwitchToken) {
    twitchUsernameInput.value = "Authenticated via OAuth";
    twitchTokenInput.value = "••••••••••••••••••••••••";
    twitchStatusPill.textContent = "Connected (Auto)";
    twitchStatusPill.classList.remove("status-off");
    twitchStatusPill.classList.add("status-on");
} else {
    twitchUsernameInput.value = "Not Connected";
    twitchStatusPill.textContent = "Disconnected";
    authWarning.innerHTML = 'Twitch is missing. <a href="/setup.html" style="color:#0020ff;">Click here to connect it.</a>';
}

/* ====== SIDEBAR TABS ====== */
document.querySelectorAll(".tab-button").forEach(btn => {
  btn.onclick = () => {
    document.querySelectorAll(".tab-button").forEach(b => b.classList.remove("active"));
    document.querySelectorAll(".tab-panel").forEach(p => p.classList.remove("active"));

    btn.classList.add("active");
    const targetId = btn.getAttribute("data-target");
    const panel = document.getElementById(targetId);
    if (panel) panel.classList.add("active");
  };
});

/* ====== VOICES (BROWSER TTS) ====== */
function loadVoices() {
  voices = speechSynthesis.getVoices();
  if (voices.length === 0) {
    setTimeout(loadVoices, 200);
    return;
  }

  kickVoiceSelect.innerHTML = "";
  timerVoiceSelect.innerHTML = "";

  voices.forEach(v => {
    const opt1 = document.createElement("option");
    opt1.value = v.name;
    opt1.textContent = v.name;
    kickVoiceSelect.appendChild(opt1);

    const opt2 = document.createElement("option");
    opt2.value = v.name;
    opt2.textContent = v.name;
    timerVoiceSelect.appendChild(opt2);
  });

  if (!kickVoiceName) kickVoiceName = voices[0].name;
  if (!timerVoiceName) timerVoiceName = voices[1]?.name || voices[0].name;

  kickVoiceSelect.value = kickVoiceName;
  timerVoiceSelect.value = timerVoiceName;
}

speechSynthesis.onvoiceschanged = loadVoices;
loadVoices();

/* ====== KICK CONNECTION (USING SAVED DATA) ====== */
function connectKick() {
  try {
    // HUGE UPGRADE: We skip the fetch API entirely. We already saved the room ID!
    const ws = new WebSocket(
      "wss://ws-us2.pusher.com/app/32cbd69e4b950bf97679?protocol=7&client=js&version=8.4.0-rc2&flash=false"
    );

    ws.onmessage = (event) => {
      const msg = JSON.parse(event.data);

      if (msg.event === "pusher:connection_established") {
        ws.send(JSON.stringify({
          event: "pusher:subscribe",
          data: { channel: `chatrooms.${savedKickID}.v2` } // Uses saved browser memory
        }));
      }

      if (msg.event === "App\\Events\\ChatMessageEvent") {
        const payload = JSON.parse(msg.data);
        const username = payload.sender?.username || "Unknown";
        const messageId = payload.id || Date.now() + "-" + Math.random();
        const text = payload.content || "";

        addMessage({
          platform: "kick",
          username,
          message: text,
          id: "kick-" + messageId
        });
      }
    };

    ws.onclose = () => setTimeout(connectKick, 5000);

  } catch (err) {
    setTimeout(connectKick, 10000);
  }
}

connectKick();

/* ====== CHAT / QUEUE ====== */
function addMessage(msg) {
  const div = document.createElement("div");
  div.className = "chat-line";
  const color = msg.platform === "kick" ? "#53fc18" : "#ff7a18";
  div.innerHTML = `<span style="color:${color};font-weight:600">[${msg.platform}] ${msg.username}:</span> ${msg.message}`;
  chatLog.appendChild(div);
  chatLog.scrollTop = chatLog.scrollHeight;

  queue.push(msg);
  queueLen.textContent = queue.length;
}

/* ====== SPEECHIFY HELPER ====== */
async function speakWithSpeechify(text) {
  if (!speechifyApiKey || !speechifyVoiceId) {
    console.warn("Speechify missing API key or voice ID");
    return false;
  }

  try {
    const res = await fetch("https://api.sws.speechify.com/v1/audio/speech", {
      method: "POST",
      headers: {
        "Authorization": "Bearer " + speechifyApiKey,
        "Content-Type": "application/json"
      },
      body: JSON.stringify({
        voice_id: speechifyVoiceId,
        text: text,
        audio_format: "mp3"
      })
    });

    if (!res.ok) return false;

    const blob = await res.blob();
    const url = URL.createObjectURL(blob);
    speechifyAudio.src = url;

    return new Promise((resolve) => {
      speechifyAudio.onended = () => {
        URL.revokeObjectURL(url);
        resolve(true);
      };
      speechifyAudio.onerror = () => {
        URL.revokeObjectURL(url);
        resolve(false);
      };
      speechifyAudio.play().catch(() => resolve(false));
    });
  } catch (e) {
    return false;
  }
}

/* ====== SPEECHIFY VOICE AUTO-LOADER ====== */
speechifyLoadVoicesBtn.onclick = async () => {
  const key = speechifyApiKeyInput.value.trim();
  if (!key) {
    speechifyStatus.textContent = "Enter your API key first.";
    return;
  }

  speechifyStatus.textContent = "Loading voices...";

  try {
    const res = await fetch("https://api.sws.speechify.com/v1/voices", {
      headers: {
        "Authorization": "Bearer " + key
      }
    });

    if (!res.ok) {
      speechifyStatus.textContent = "Failed to load voices. Check API key.";
      return;
    }

    const voices = await res.json();
    speechifyVoiceDropdown.innerHTML = "";

    voices.forEach(v => {
      const opt = document.createElement("option");
      opt.value = v.voice_id;
      opt.textContent = v.name || v.voice_id;
      speechifyVoiceDropdown.appendChild(opt);
    });

    speechifyStatus.textContent = "Voices loaded.";

    if (voices.length > 0) {
      speechifyVoiceDropdown.value = voices[0].voice_id;
      speechifyVoiceIdInput.value = voices[0].voice_id;
      speechifyVoiceId = voices[0].voice_id;
    }

  } catch (err) {
    speechifyStatus.textContent = "Error loading voices.";
  }
};

speechifyVoiceDropdown.onchange = () => {
  speechifyVoiceIdInput.value = speechifyVoiceDropdown.value;
  speechifyVoiceId = speechifyVoiceDropdown.value;
};

/* ====== TTS LOOP (ENGINE SWITCH) ====== */
setInterval(async () => {
  if (!audioEnabled || !isPlaying || isMuted || isSpeaking || queue.length === 0) return;

  const next = queue.shift();
  queueLen.textContent = queue.length;

  const text = readUsernameBox.checked
    ? `${next.username} says: ${next.message}`
    : next.message;

  isSpeaking = true;
  speakingNow.textContent = `${next.username}: ${next.message}`;

  if (ttsEngine === "speechify") {
    const ok = await speakWithSpeechify(text);
    if (!ok) {
      // fallback to browser TTS
      const utter = new SpeechSynthesisUtterance(text);
      utter.volume = volume;
      utter.rate = rate;
      utter.pitch = pitch;
      const voiceName = next.platform === "kick" ? kickVoiceName : timerVoiceName;
      const voice = voices.find(v => v.name === voiceName);
      if (voice) utter.voice = voice;
      utter.onend = () => {
        isSpeaking = false;
        speakingNow.textContent = "None";
      };
      speechSynthesis.speak(utter);
    } else {
      isSpeaking = false;
      speakingNow.textContent = "None";
    }
  } else {
    const utter = new SpeechSynthesisUtterance(text);
    utter.volume = volume;
    utter.rate = rate;
    utter.pitch = pitch;
    const voiceName = next.platform === "kick" ? kickVoiceName : timerVoiceName;
    const voice = voices.find(v => v.name === voiceName);
    if (voice) utter.voice = voice;
    utter.onend = () => {
      isSpeaking = false;
      speakingNow.textContent = "None";
    };
    speechSynthesis.speak(utter);
  }
}, 100);

/* ====== MULTI TIMER ====== */
function renderTimers() {
  timersList.innerHTML = "";
  timers.forEach(t => {
    const div = document.createElement("div");
    div.className = "timer-item";
    const intervalSec = Math.round(t.intervalMs / 1000);
    div.innerHTML = `
      <div><strong style="color:#ff7a18;">${t.message}</strong></div>
      <div class="timer-meta">
        Every ${intervalSec} seconds<br>
        Last fired: ${t.lastFired ? new Date(t.lastFired).toLocaleTimeString() : "Never"}
      </div>
      <div style="margin-top:6px;">
        <button data-id="${t.id}" class="toggleTimerBtn">
          ${t.enabled ? "Disable" : "Enable"}
        </button>
        <button data-id="${t.id}" class="deleteTimerBtn">
          Delete
        </button>
      </div>
    `;
    timersList.appendChild(div);
  });

  document.querySelectorAll(".toggleTimerBtn").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-id");
      const timer = timers.find(t => t.id === id);
      if (!timer) return;
      timer.enabled = !timer.enabled;
      renderTimers();
    };
  });

  document.querySelectorAll(".deleteTimerBtn").forEach(btn => {
    btn.onclick = () => {
      const id = btn.getAttribute("data-id");
      timers = timers.filter(t => t.id !== id);
      renderTimers();
    };
  });
}

function addTimerFromUI() {
  timerError.textContent = "";

  if (timers.length >= 15) {
    timerError.textContent = "You already have 15 timers. Delete one to add another.";
    return;
  }

  const msg = (timerMessageInput.value || "").trim();
  if (!msg) {
    timerError.textContent = "Please enter a timer message.";
    return;
  }

  let intervalSec;
  const preset = timerPresetSelect.value;
  if (preset === "custom") {
    const custom = parseInt(customIntervalInput.value, 10);
    if (isNaN(custom) || custom <= 0) {
      timerError.textContent = "Custom interval must be a positive number of seconds.";
      return;
    }
    intervalSec = custom;
  } else {
    intervalSec = parseInt(preset, 10);
  }

  const timer = {
    id: "timer-" + Date.now() + "-" + Math.random(),
    message: msg,
    intervalMs: intervalSec * 1000,
    enabled: true,
    lastFired: 0
  };

  timers.push(timer);
  timerMessageInput.value = "";
  renderTimers();
}

timerPresetSelect.onchange = () => {
  if (timerPresetSelect.value === "custom") {
    customIntervalWrapper.style.display = "block";
  } else {
    customIntervalWrapper.style.display = "none";
  }
};

addTimerBtn.onclick = addTimerFromUI;

setInterval(() => {
  const now = Date.now();
  timers.forEach(t => {
    if (!t.enabled) return;
    if (!t.lastFired || now - t.lastFired >= t.intervalMs) {
      t.lastFired = now;
      addMessage({
        platform: "timer",
        username: "Timer",
        message: t.message,
        id: t.id + "-" + now
      });
    }
  });
  renderTimers();
}, 500);

/* ====== UI EVENTS ====== */
enableAudioBtn.onclick = () => {
  audioEnabled = true;
  const starter = new SpeechSynthesisUtterance(" ");
  speechSynthesis.speak(starter);
  const u = new SpeechSynthesisUtterance("Audio enabled.");
  speechSynthesis.speak(u);
};

playPauseBtn.onclick = () => {
  isPlaying = !isPlaying;
  playPauseBtn.textContent = isPlaying ? "Pause" : "Play";
};

muteBtn.onclick = () => {
  isMuted = !isMuted;
  muteBtn.textContent = isMuted ? "Unmute" : "Mute";
};

testTtsBtn.onclick = () => {
  if (!audioEnabled) return alert("Enable audio first.");
  addMessage({
    platform: "timer",
    username: "System",
    message: "This is a Jailex TTS test.",
    id: "test-" + Date.now()
  });
};

testTimerBtn.onclick = () => {
  addMessage({
    platform: "timer",
    username: "Timer",
    message: "Timer event fired.",
    id: "timer-" + Date.now()
  });
};

kickVoiceSelect.onchange = () => kickVoiceName = kickVoiceSelect.value;
timerVoiceSelect.onchange = () => timerVoiceName = timerVoiceSelect.value;

volumeSlider.oninput = () => volume = parseFloat(volumeSlider.value);
rateSlider.oninput = () => rate = parseFloat(rateSlider.value);
pitchSlider.oninput = () => pitch = parseFloat(pitchSlider.value);
</script>

</body>
</html>
